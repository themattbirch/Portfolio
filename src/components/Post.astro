---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

interface Props {
  post: CollectionEntry<"posts">;
  index: number;
}

const { post, index } = Astro.props;
const postUrl = `/blog/${post.slug}`;

// Move this to a shared utils file since it's used in both components
const formatCategoryUrl = (category: string): string => {
  return category
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9-]/g, "")
    .replace(/-+/g, "-");
};

// Add a safety check for description length
const getDescription = (post: Props["post"]): string => {
  if (post.data.description) return post.data.description;
  return post.body.length > 150 ? `${post.body.slice(0, 150)}...` : post.body;
};

const description = getDescription(post);
const firstCategory = post.data.categories[0];
---

<article
  class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden
         transition-transform hover:scale-105 duration-300 flex flex-col"
>
  <a href={postUrl} class="block aspect-video">
    <Image
      src={post.data.image}
      alt={post.data.title}
      width={400}
      height={225}
      class="w-full h-40 sm:h-48 object-cover"
      loading={index <= 2 ? "eager" : "lazy"}
    />
  </a>
  <div class="p-4 sm:p-6 flex-1 flex flex-col">
    <h2
      class="text-lg sm:text-xl font-semibold mb-2 text-gray-800 dark:text-white"
    >
      <a href={postUrl} class="hover:text-blue-600 dark:hover:text-blue-400">
        {post.data.title}
      </a>
    </h2>
    <p
      class="text-sm sm:text-base text-gray-600 dark:text-gray-300 mb-4
             line-clamp-3 flex-grow"
    >
      {description}
    </p>

    <div class="mt-auto">
      <div class="flex items-center justify-between">
        <a
          href={postUrl}
          class="text-blue-600 dark:text-blue-400 hover:underline
                 text-sm sm:text-base"
        >
          Read More
        </a>

        <time
          datetime={post.data.date.raw.toISOString()}
          class="text-gray-500 dark:text-gray-400 text-xs sm:text-sm"
        >
          {post.data.date.formatted}
        </time>

        {
          firstCategory && (
            <a
              href={`/category/${formatCategoryUrl(firstCategory)}`}
              class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 
                   rounded dark:bg-blue-200 dark:text-blue-800"
            >
              {firstCategory}
            </a>
          )
        }
      </div>
    </div>
  </div>
</article>
